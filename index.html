<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vrilliant Chat</title>
<style>
  :root{
    --bg:#071022; --panel:#0b1220; --muted:#9fb0d0; --accent:#5865F2;
    --bubble-you:#24304f; --bubble-other:#0b2638;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#05101b 0%, #071022 100%);color:var(--muted);display:flex;align-items:flex-start;justify-content:center;padding:12px}
  a{color:var(--accent)}
  .app{width:980px;max-width:100%;height:880px;max-height:100vh;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;background:linear-gradient(180deg,#06101a 0%, #071122 100%);box-shadow: 0 10px 40px rgba(2,6,23,.6);}
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.03);gap:12px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#6b79ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:white}
  .title{font-size:15px;font-weight:600}
  .top-actions{display:flex;gap:8px;align-items:center}
  .icon-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:10px;color:var(--muted);cursor:pointer;font-size:13px}
  .toggle-btn{background:transparent;border:none;color:var(--muted);cursor:pointer;padding:6px 8px;border-radius:8px;font-size:13px}
  .small{font-size:13px;color:rgba(230,238,248,.75)}
  .shell{display:flex;flex:1;min-height:0}
  .sidebar{
    width:300px;min-width:260px;background:linear-gradient(180deg,#061224, #071225);padding:12px;border-right:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:10px;
  }
  .sidebar .section-title{font-size:12px;color:rgba(230,238,248,.6);margin-bottom:6px}
  .dm-list{display:flex;flex-direction:column;gap:8px;overflow:auto;padding-right:6px}
  .dm-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;cursor:pointer}
  .dm-item:hover{background:rgba(255,255,255,0.02)}
  .dm-bubble{width:40px;height:40px;border-radius:9px;background:#0f1b2b;display:flex;align-items:center;justify-content:center;font-weight:700}
  .dm-meta{flex:1;display:flex;flex-direction:column}
  .dm-name{font-weight:600;color:#e6eef8}
  .dm-sub{font-size:12px;color:rgba(230,238,248,.6)}
  .dm-actions{display:flex;gap:6px}
  .muted{color:rgba(230,238,248,.5);font-size:12px}
  .controls{display:flex;gap:8px;margin-top:6px}
  .btn{background:var(--accent);border:none;color:white;padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:600}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px;border-radius:10px;cursor:pointer}
  .main{flex:1;display:flex;flex-direction:column;min-width:0}
  .chat-wrap{flex:1;display:flex;flex-direction:column;min-height:0}
  .messages{flex:1;padding:14px;overflow:auto;display:flex;flex-direction:column;gap:8px}
  .meta-line{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .input-bar{display:flex;gap:8px;padding:10px;border-top:1px solid rgba(255,255,255,0.03);align-items:center}
  .input{flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;font-size:15px}
  .send{background:var(--accent);border:none;color:white;padding:10px 14px;border-radius:12px;cursor:pointer}
  .msg{max-width:78%;padding:10px 12px;border-radius:14px;line-height:1.25;word-wrap:break-word;box-shadow: 0 4px 14px rgba(0,0,0,0.35)}
  .msg.you{align-self:flex-end;background:var(--bubble-you);border-bottom-right-radius:6px}
  .msg.other{align-self:flex-start;background:var(--bubble-other);border-bottom-left-radius:6px}
  .msg .meta{font-size:12px;color:rgba(230,238,248,.7);margin-bottom:6px}
  @media (max-width:720px){
    body{padding:8px}
    .app{height:100vh;border-radius:0;max-width:100%}
    .sidebar{position:fixed;left:0;top:64px;bottom:0;z-index:40;transform:translateX(-110%);transition:transform .22s ease;padding:12px}
    .sidebar.open{transform:translateX(0)}
    .shell{flex-direction:column}
    .topbar{position:sticky;top:0;z-index:30}
    .chat-wrap{padding-bottom:68px}
    .meta-line{padding:8px 12px}
    .logo{width:32px;height:32px}
  }
  body.desktop-mode .logo{width:30px;height:30px;border-radius:8px}
  body.desktop-mode .sidebar{width:260px}
  body.desktop-mode .dm-item{padding:6px}
  body.desktop-mode .input{padding:8px}
  .row{display:flex;gap:8px;align-items:center}
  .muted-chip{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:12px}
  .messages::-webkit-scrollbar{width:8px}
  .messages::-webkit-scrollbar-thumb{background:#1e2b3a;border-radius:6px}
  .dm-list::-webkit-scrollbar{width:8px}
  *{scroll-behavior:smooth}
</style>
</head>
<body>
<div class="app" role="application" aria-label="Vrilliant Chat">
  <div class="topbar">
    <div class="brand">
      <div class="logo">VC</div>
      <div>
        <div class="title">Vrilliant Chat</div>
        <div class="small">Ephemeral • Complete Anonimity</div>
      </div>
    </div>
    <div class="top-actions">
      <button id="toggleLayout" class="toggle-btn" title="Toggle Mobile/Desktop">Desktop view</button>
      <button id="openSidebar" class="icon-btn" title="Open sidebar">Rooms</button>
    </div>
  </div>
  <div class="shell">
    <aside class="sidebar" id="sidebar" aria-hidden="false">
      <div>
        <div class="section-title">Your DMs</div>
        <div class="dm-list" id="dmList"></div>
      </div>
      <div style="margin-top:8px">
        <div class="controls">
          <button id="newRoom" class="btn">New DM</button>
          <button id="importLink" class="ghost">Join</button>
        </div>
        <div style="margin-top:8px" class="small muted">Tap a DM to open. Long-press (or click …) to remove from list.</div>
      </div>
      <div style="margin-top:16px">
        <div class="section-title">Settings</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <label class="small">Message TTL (sec)</label>
          <input id="ttl" type="number" value="120" min="5" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)" />
          <label class="small"><input id="autoscroll" type="checkbox" checked /> Auto-scroll</label>
          <button id="clearLocal" class="ghost">Clear saved DMs</button>
        </div>
      </div>
    </aside>
    <main class="main">
      <div class="meta-line">
        <div id="roomTitle">
          <strong id="roomLabel">—</strong>
          <span id="userIdDisplay" style="margin-left:10px;color:var(--muted);font-weight:600"></span>
        </div>
        <div class="row">
          <button id="copyLink" class="icon-btn">Copy link</button>
          <div class="muted-chip" id="activeCount">0 online</div>
        </div>
      </div>
      <div class="chat-wrap">
        <div class="messages" id="messages" aria-live="polite"></div>
      </div>
      <div class="input-bar">
        <input id="inputText" class="input" placeholder="Message… (Enter to send)" autocomplete="off" />
        <button id="sendBtn" class="send">Send</button>
      </div>
    </main>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
/* ========= FIREBASE CONFIG ========= */
const firebaseConfig = {
  apiKey: "AIzaSyCblhB8NO5hMPT1of6eOnLm507e7e7TQV4",
  authDomain: "skibidii.firebaseapp.com",
  databaseURL: "https://skibidii-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "skibidii",
  storageBucket: "skibidii.firebasestorage.app",
  messagingSenderId: "1090897761573",
  appId: "1:1090897761573:web:a5c86e7950b6bcd0f6f6cc",
  measurementId: "G-T4SC8WEXXP"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ------------------------ DOM refs ------------------------ */
const dmListEl = document.getElementById('dmList');
const newRoomBtn = document.getElementById('newRoom');
const importLinkBtn = document.getElementById('importLink');
const clearLocalBtn = document.getElementById('clearLocal');
const messagesEl = document.getElementById('messages');
const inputText = document.getElementById('inputText');
const sendBtn = document.getElementById('sendBtn');
const ttlInput = document.getElementById('ttl');
const autoscrollCheckbox = document.getElementById('autoscroll');
const copyLinkBtn = document.getElementById('copyLink');
const roomLabel = document.getElementById('roomLabel');
const userIdDisplay = document.getElementById('userIdDisplay');
const toggleLayoutBtn = document.getElementById('toggleLayout');
const openSidebarBtn = document.getElementById('openSidebar');
const sidebarEl = document.getElementById('sidebar');
const activeCountEl = document.getElementById('activeCount');

/* ------------------------ Helpers ------------------------ */
function makeId(len=6){const chars='abcdefghijklmnopqrstuvwxyz0123456789';let s='';for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];return s;}
function now(){return Date.now();}
function uid(){return 'U-'+Math.random().toString(36).slice(2,8).toUpperCase();}

/* ------------------------ Local storage ------------------------ */
const LS_KEY='anon_dms_v1';
function loadSavedDMs(){try{return JSON.parse(localStorage.getItem(LS_KEY)||'[]');}catch(e){return[];}}
function saveSavedDMs(arr){localStorage.setItem(LS_KEY,JSON.stringify(arr));renderSavedDMs();}
function addSavedDM(room,name){const list=loadSavedDMs();if(list.find(x=>x.room===room)) return; list.unshift({room,name:name||('DM-'+room.slice(0,4).toUpperCase()),created:now()}); saveSavedDMs(list);}
function removeSavedDM(room){saveSavedDMs(loadSavedDMs().filter(x=>x.room!==room));}
function renderSavedDMs(){
  const list=loadSavedDMs(); dmListEl.innerHTML='';
  if(!list.length){dmListEl.innerHTML='<div class="small muted">No saved DMs yet — create a new one.</div>'; return;}
  list.forEach(entry=>{
    const item=document.createElement('div'); item.className='dm-item';
    item.innerHTML=`<div class="dm-bubble">${entry.name.slice(0,2).toUpperCase()}</div>
      <div class="dm-meta"><div class="dm-name">${entry.name}</div><div class="dm-sub">#${entry.room}</div></div>
      <div class="dm-actions"><button class="ghost" title="Open">Open</button><button class="ghost delete" title="Remove">Remove</button></div>`;
    item.querySelector('.ghost').addEventListener('click',()=>{joinRoom(entry.room);});
    item.querySelector('.dm-bubble').addEventListener('click',()=>{joinRoom(entry.room);});
    item.querySelector('.dm-name').addEventListener('click',()=>{joinRoom(entry.room);});
    item.querySelector('.delete').addEventListener('click',()=>{removeSavedDM(entry.room);});
    dmListEl.appendChild(item);
  });
}

/* ------------------------ Room & Firebase refs ------------------------ */
let room=null; let userId=uid(); userIdDisplay.textContent=userId;
let roomRef=null, msgsRef=null, presenceRef=null, myPresenceRef=null, metaRef=null;
const connectedRef=db.ref('.info/connected');
function setRoomLabel(r){roomLabel.textContent=r?'#'+r:'—';}

/* ------------------------ joinRoom ------------------------ */
function joinRoom(r){
  if(msgsRef) msgsRef.off();
  if(presenceRef) presenceRef.off();
  if(roomRef) roomRef.off();
  room=r;
  setRoomLabel(room);
  history.replaceState(null,'','?room='+room);
  roomRef=db.ref('rooms/'+room);
  msgsRef=db.ref('rooms/'+room+'/messages');
  presenceRef=db.ref('rooms/'+room+'/presence');
  myPresenceRef=presenceRef.child(userId);
  metaRef=db.ref('rooms/'+room+'/meta');
  renderMessagesClear();
  connectedRef.on('value',snap=>{if(snap.val()===true){myPresenceRef.set(true);myPresenceRef.onDisconnect().remove(); metaRef.child('lastActive').onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);}});
  presenceRef.on('value',snap=>{const cnt=snap.numChildren(); activeCountEl.textContent=cnt+' online'; if(cnt===0){msgsRef.remove().catch(()=>{});}});
  msgsRef.limitToLast(200).on('child_added',snap=>{renderMessage(snap.key,snap.val());});
  msgsRef.on('child_removed',snap=>{const el=document.getElementById('m-'+snap.key);if(el) el.remove();});
  msgsRef.limitToLast(200).once('value',snap=>{snap.forEach(child=>renderMessage(child.key,child.val())); if(autoscrollCheckbox.checked) messagesEl.scrollTop=messagesEl.scrollHeight;});
  addSavedDM(room,'DM-'+room.slice(0,4).toUpperCase());
}

/* ------------------------ Messages ------------------------ */
function renderMessagesClear(){messagesEl.innerHTML='';}
function renderMessage(id,msg){if(!msg)return;if(document.getElementById('m-'+id))return;
  const el=document.createElement('div'); el.id='m-'+id; el.className='msg '+(msg.user===userId?'you':'other');
  const meta=document.createElement('div'); meta.className='meta'; meta.textContent=(msg.user===userId?'You':msg.user)+' • '+new Date(msg.ts||now()).toLocaleTimeString();
  const body=document.createElement('div'); body.textContent=msg.text; el.appendChild(meta); el.appendChild(body); messagesEl.appendChild(el);
  if(autoscrollCheckbox.checked) messagesEl.scrollTop=messagesEl.scrollHeight;
}

/* ------------------------ Send ------------------------ */
async function sendMessage(){
  const text=inputText.value.trim(); if(!text)return;
  const t=Math.max(5, Number(ttlInput.value)||120);
  const payload={user:userId,text,ts:now(),expireAt:now()+t*1000};
  try{await msgsRef.push(payload); metaRef.child('lastActive').set(firebase.database.ServerValue.TIMESTAMP); inputText.value='';}
  catch(e){console.error('send failed',e); alert('Send failed — check Firebase config/rules & network.');}
}
sendBtn.addEventListener('click',sendMessage);
inputText.addEventListener('keydown',e=>{if(e.key==='Enter')sendMessage();});

/* prune expired */
async function pruneExpired(){try{const snap=await msgsRef.once('value');const nowTS=now();const updates={};snap.forEach(child=>{const m=child.val();if(m&&m.expireAt&&m.expireAt<=nowTS)updates[child.key]=null;});if(Object.keys(updates).length) await msgsRef.update(updates);}catch(e){}}
setInterval(pruneExpired,10000); connectedRef.on('value',v=>{if(v.val()===true)pruneExpired();}); pruneExpired();

/* ------------------------ Controls ------------------------ */
newRoomBtn.addEventListener('click',()=>{const r=makeId(6); joinRoom(r); sidebarEl.classList.add('open');});
copyLinkBtn.addEventListener('click',async()=>{try{await navigator.clipboard.writeText(location.origin+location.pathname+'?room='+room); copyLinkBtn.textContent='Copied!'; setTimeout(()=>copyLinkBtn.textContent='Copy link',1200);}catch(e){alert('Copy failed — copy the URL manually.');}});
importLinkBtn.addEventListener('click',()=>{let link=prompt('Paste a room code or full link (example: ?room=abc123 or abc123):'); if(!link)return; let code=link.trim(); if(code.includes('?room=')) code=new URL(code,location.origin).searchParams.get('room'); addSavedDM(code); joinRoom(code);});
clearLocalBtn.addEventListener('click',()=>{if(!confirm('Clear saved DMs from this browser?'))return; localStorage.removeItem(LS_KEY); renderSavedDMs();});
openSidebarBtn.addEventListener('click',()=>{sidebarEl.classList.toggle('open');});
document.addEventListener('click',e=>{if(window.innerWidth<=720){if(!sidebarEl.contains(e.target)&&!openSidebarBtn.contains(e.target))sidebarEl.classList.remove('open');}});
toggleLayoutBtn.addEventListener('click',()=>{document.body.classList.toggle('desktop-mode'); toggleLayoutBtn.textContent=document.body.classList.contains('desktop-mode')?'Mobile view':'Desktop view';});

/* ------------------------ Init ------------------------ */
renderSavedDMs();
const params=new URLSearchParams(location.search); let initialRoom=params.get('room');
if(initialRoom){addSavedDM(initialRoom,'DM-'+initialRoom.slice(0,4).toUpperCase()); joinRoom(initialRoom);}
else{const saved=loadSavedDMs(); if(saved.length) joinRoom(saved[0].room); else joinRoom(makeId(6));}
window.addEventListener('resize',()=>{if(autoscrollCheckbox.checked) messagesEl.scrollTop=messagesEl.scrollHeight;});
</script>
</body>
</html>
